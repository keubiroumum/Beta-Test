<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      background-color: #e0f7fa;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    form {
      width: 100%;
      max-width: 800px;
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
    }
    label {
      display: flex;
      align-items: center;
      font-weight: bold;
      white-space: nowrap;
    }
    input[type="text"], select, textarea {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #cccccc;
      border-radius: 4px;
      box-sizing: border-box;
      text-align: left;
      vertical-align: top;
    }
    input[type="submit"] {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      grid-column: span 2;
      padding: 12px;
      font-size: 16px;
    }
    input[type="submit"]:hover {
      background-color: #0056b3;
    }
    .long-input {
      grid-column: span 2;
      height: 100px;
      resize: vertical;
    }
    .info {
      grid-column: span 2;
      margin-top: 10px;
      font-size: 20px;
      font-weight: bold;
    }
    .header {
      grid-column: span 2;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <form id="inputForm">
    <div class="header">BIRO HUKUM</div>
    
    <label for="orderNumber">Nomor Order:</label>
    <input type="text" id="orderNumber" name="orderNumber">
    
    <label for="activity">Kegiatan:</label>
    <select id="activity" name="activity" onchange="updateSubActivities()"></select>
    
    <label for="subActivity">Sub Kegiatan:</label>
    <select id="subActivity" name="subActivity" onchange="updateExpenses()"></select>
    
    <label for="expense">Belanja:</label>
    <select id="expense" name="expense" onchange="updateSisaAngkas()"></select>
    
    <label for="description">Uraian:</label>
    <textarea id="description" name="description" class="long-input"></textarea>
    
    <label for="invoiceAmount">Nilai Tagihan:</label>
    <input type="text" id="invoiceAmount" name="invoiceAmount" oninput="validateInvoiceAmount()">
    
    <label for="recipient">Penerima:</label>
    <input type="text" id="recipient" name="recipient">
    
    <label for="status">Status:</label>
    <select id="status" name="status"></select>
    
    <div class="info">
      <strong>Sisa Angkas:</strong> <span id="sisaAngkas">-</span>
    </div>
    
    <input type="submit" value="Submit">
  </form>

<script>
  function formatRupiah(angka) {
    var numberString = angka.replace(/[^,\d]/g, '').toString(),
      split = numberString.split(','),
      sisa = split[0].length % 3,
      rupiah = split[0].substr(0, sisa),
      ribuan = split[0].substr(sisa).match(/\d{3}/gi);

    if (ribuan) {
      separator = sisa ? '.' : '';
      rupiah += separator + ribuan.join('.');
    }

    rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
    return 'Rp ' + rupiah;
  }

  function validateInvoiceAmount() {
    var invoiceAmountInput = document.getElementById('invoiceAmount');
    var sisaAngkas = document.getElementById('sisaAngkas').textContent.replace(/[Rp .]/g, '');
    var invoiceAmount = invoiceAmountInput.value.replace(/[Rp .]/g, '');

    if (parseInt(invoiceAmount) > parseInt(sisaAngkas)) {
      alert('Sisa angkas tidak mencukupi untuk kegiatan belanja ini');
      invoiceAmountInput.value = '';
    } else {
      invoiceAmountInput.value = formatRupiah(invoiceAmount);
    }
  }

  function updateSubActivities() {
    var activity = document.getElementById('activity').value;
    google.script.run.withSuccessHandler(function(subActivities) {
      var subActivitySelect = document.getElementById('subActivity');
      subActivitySelect.innerHTML = '<option value="">Pilih Sub Kegiatan</option>';
      subActivities.forEach(function(subActivity) {
        var option = document.createElement('option');
        option.value = subActivity;
        option.text = subActivity;
        subActivitySelect.add(option);
      });
      updateExpenses();
    }).getSubActivities(activity);
  }

  function updateExpenses() {
    var subActivity = document.getElementById('subActivity').value;
    google.script.run.withSuccessHandler(function(expenses) {
      var expenseSelect = document.getElementById('expense');
      expenseSelect.innerHTML = '<option value="">Pilih Belanja</option>';
      expenses.forEach(function(expense) {
        var option = document.createElement('option');
        option.value = expense;
        option.text = expense;
        expenseSelect.add(option);
      });
      updateSisaAngkas();
    }).getExpenses(subActivity);
  }

  function updateStatus() {
    google.script.run.withSuccessHandler(function(statusOptions) {
      var statusSelect = document.getElementById('status');
      statusSelect.innerHTML = '<option value="">Pilih Status</option>';
      statusOptions.forEach(function(status) {
        var option = document.createElement('option');
        option.value = status;
        option.text = status;
        statusSelect.add(option);
      });
    }).getStatusOptions();
  }

  function updateSisaAngkas() {
    var belanja = document.getElementById('expense').value;
    google.script.run.withSuccessHandler(function(sisaAngkas) {
      document.getElementById('sisaAngkas').textContent = formatRupiah(sisaAngkas.toString());
    }).getSisaAngkas(belanja);
  }

  function clearForm() {
    document.getElementById('orderNumber').value = '';
    document.getElementById('description').value = '';
    document.getElementById('invoiceAmount').value = '';
    document.getElementById('recipient').value = '';
    document.getElementById('sisaAngkas').textContent = '-';

    // Reset dropdowns
    var activitySelect = document.getElementById('activity');
    activitySelect.innerHTML = '<option value="">Pilih Kegiatan</option>';
    var subActivitySelect = document.getElementById('subActivity');
    subActivitySelect.innerHTML = '<option value="">Pilih Sub Kegiatan</option>';
    var expenseSelect = document.getElementById('expense');
    expenseSelect.innerHTML = '<option value="">Pilih Belanja</option>';
    var statusSelect = document.getElementById('status');
    statusSelect.innerHTML = '<option value="">Pilih Status</option>';

    // Re-fetch activities and statuses to populate dropdowns
    google.script.run.withSuccessHandler(function(activities) {
      activities.forEach(function(activity) {
        var option = document.createElement('option');
        option.value = activity;
        option.text = activity;
        activitySelect.add(option);
      });
      updateSubActivities();
    }).getActivities();
    
    google.script.run.withSuccessHandler(function(statusOptions) {
      statusOptions.forEach(function(status) {
        var option = document.createElement('option');
        option.value = status;
        option.text = status;
        statusSelect.add(option);
      });
    }).getStatusOptions();
  }

  document.addEventListener('DOMContentLoaded', function() {
    clearForm();
  });

  document.getElementById('inputForm').addEventListener('submit', function(event) {
  event.preventDefault();
  var formData = {
    orderNumber: document.getElementById('orderNumber').value,
    activity: document.getElementById('activity').value,
    subActivity: document.getElementById('subActivity').value,
    expense: document.getElementById('expense').value,
    description: document.getElementById('description').value,
    invoiceAmount: document.getElementById('invoiceAmount').value,
    recipient: document.getElementById('recipient').value,
    status: document.getElementById('status').value
  };
  google.script.run.withSuccessHandler(function(response) {
    alert(response);
    clearForm();
  }).submitData(formData);
});
</script>
</body>
</html>
